{% extends 'cabinet/cabinet_base.html' %}
{% block extra_js %}
<script src="//api-maps.yandex.ru/2.1/?lang=ru_RU" type="text/javascript"></script>
<script>
ymaps.ready(init);

function init() {
    var myMap = new ymaps.Map("map", {
            center: [48.709866, 44.521522],
            zoom: 13
        }, {
            searchControlProvider: 'yandex#search'
    });
    ymaps.route([
        {% for i in object.gpspoint_set.all %}'{{ i.name|safe }}',{% endfor %}
    ]).then(function (route) {
        myMap.geoObjects.add(route);
        var points = route.getWayPoints();
        points.options.set('preset', 'islands#redStretchyIcon');
    }, function (error) {
        alert('Возникла ошибка: ' + error.message);
    });
};
</script>
{% endblock %}
{% block content %}
  <div class="container">
    <div class="col-lg-12">
      <ol class="breadcrumb">
        <li><a href="{% url 'dashboard:index' %}">Рабочий стол</a></li>
        <li><a href="{% url 'distributor:task-list' %}">Список задач для распространителей</a></li>
        <li class="active">Редактирование задачи</li>
      </ol>
      <div class="panel panel-default">
        <div class="panel-heading">
          <p class="lead text-center remove-bottom">
            Редактирование задачи {{ object }}
          </p>
        </div>
        <div class="panel-body">
          {% if success %}
            <p class="alert alert-success">{{ success }}</p>
          {% elif error %}
            <p class="alert alert-danger">{{ error }}</p>
          {% endif %}
          <ul class="nav nav-tabs">
            <li class="active"><a data-toggle="tab" href="#task">Задача</a></li>
            <li><a data-toggle="tab" href="#task_map">Карта</a></li>
          </ul>
          <div class="tab-content">
            <div id="task" class="tab-pane fade in active">
              <br>
              <div class="col-lg-6">
                <form action="" role="form" id="js-form-distributor-task-update" method="post">
                  {% csrf_token %}
                  {{ form.errors }}
                  <div class="form-group" data-url="{% url 'distributor:get_task_initial' %}">
                    <div class="col-lg-5">{{ form.sale.label_tag }}</div>
                    <div class="col-lg-7">
                      {{ form.sale }}
                      <strong>{{ object.sale }}</strong>
                    </div>
                    {{ form.sale.errors }}
                    <div class="clearfix"></div>
                  </div>
                  <div class="form-group">
                    <div class="col-lg-5">{{ form.order.label_tag }}</div>
                    <div class="col-lg-7">{{ form.order }}</div>
                    {{ form.order.errors }}
                    <div class="clearfix"></div>
                  </div>
                  <div class="form-group">
                    <div class="col-lg-5">{{ form.distributor.label_tag }}</div>
                    <div class="col-lg-7">{{ form.distributor }}</div>
                    {{ form.distributor.errors }}
                    <div class="clearfix"></div>
                  </div>
                  <div class="form-group">
                    <div class="col-lg-5">{{ form.area.label_tag }}</div>
                    <div class="col-lg-7">{{ form.area }}</div>
                    {{ form.area.errors }}
                    <div class="clearfix"></div>
                  </div>
                  <div class="form-group">
                    <div class="col-lg-5">{{ form.type.label_tag }}</div>
                    <div class="col-lg-7">{{ form.type }}</div>
                    {{ form.type.errors }}
                    <div class="clearfix"></div>
                  </div>
                  <div class="form-group">
                    <div class="col-lg-5">{{ form.material_count.label_tag }}</div>
                    <div class="col-lg-7">{{ form.material_count }}</div>
                    {{ form.material_count.errors }}
                    <div class="clearfix"></div>
                  </div>
                  <div class="form-group">
                    <div class="col-lg-5">{{ form.date.label_tag }}</div>
                    <div class="col-lg-7">{{ form.date }}</div>
                    {{ form.date.errors }}
                    <div class="clearfix"></div>
                  </div>
                  <div class="form-group">
                    <div class="col-lg-5">{{ form.define_address.label_tag }}</div>
                    <div class="col-lg-7">{{ form.define_address }}</div>
                    {{ form.define_address.errors }}
                    <div class="clearfix"></div>
                  </div>
                  <div class="form-group">
                    <div class="col-lg-5">{{ form.comment.label_tag }}</div>
                    <div class="col-lg-7">{{ form.comment }}</div>
                    {{ form.comment.errors }}
                    <div class="clearfix"></div>
                  </div>
                  <button type="submit" class="btn btn-success">Сохранить</button>
                </form>
              </div>
            </div>
            <div id="task_map" class="tab-pane fade">
              <div id="map" style="width:100%; height:500px"></div>
              <div id="photo_list">
              {% if point_list %}
                <table class="table">
                  <thead>
                    <tr>
                      <th>адрес</th>
                      <th>время</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                  {% for point in point_list %}
                  {% for photo in point.pointphoto_set.all %}
                  <tr>
                    <td>{{ photo.name|default:'Не указано' }}</td>
                    <td>{{ photo.timestamp|default:'Не указано' }}</td>
                    <td>
                      <a href="{{ photo.photo.url }}" rel="group" class="js-gallery" title="{{ photo.name }}, время {{ photo.timestamp }}">
                        <span class="glyphicon glyphicon-zoom-in"></span>
                      </a>
                    </td>
                  </tr>
                  {% endfor %}
                  {% endfor %}
                  </tbody>
                </table>
              {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}